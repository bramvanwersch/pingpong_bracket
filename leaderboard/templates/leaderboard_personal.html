{% extends 'app.html' %}
{% load static %}
{% block js-packages %}
    <script type="text/javascript" src="{% static "js-packages/chart.js" %}"></script>
{% endblock %}
{% block app %}
    <div style="display: flex">
        <div style="flex: 45%">
            <h2>
                Profile for {{ profile.name }}
            </h2>
        </div>
        <div style="flex: 10%">
        </div>
        <div style="flex: 45%">
            <label for="compare" style="margin-right: 5px">Compare to: </label>
            <select id="compare" style="margin-right: 10px;">
                {% for name in names %}
                    <option value="{{ name }}">
                        {{ name }}
                    </option>
                {% endfor %}
            </select>
            <button onclick="compare_func()">Compare</button>
        </div>
    </div>
    <div style="display: flex">
        <div style="flex: 50%">

            <table>
                <tbody>
                <tr>
                    <td>
                        Wins:
                    </td>
                    <td>
                        {{ profile.wins }}
                    </td>
                </tr>
                <tr>
                    <td>
                        Losses:
                    </td>
                    <td>
                        {{ profile.losses }}
                    </td>
                </tr>
                <tr>
                    <td>
                        Ties:
                    </td>
                    <td>
                        {{ profile.ties }}
                    </td>
                </tr>
                <tr>
                    <td>
                        Total:
                    </td>
                    <td>
                        {{ profile.total_games }}
                    </td>
                </tr>
                <tr>
                    <td>
                        Rating:
                    </td>
                    <td>
                        {{ profile.rating }}
                    </td>
                </tr>
                <tr>
                    <td>
                        Win percentage:
                    </td>
                    <td>
                        {{ profile.winrate }} %
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div style="flex: 50%">
            <canvas id="rating-progression"></canvas>
        </div>
    </div>
    <hr>
    <h3>
        Recent matches
    </h3>
    <table>
        <thead>
        <tr>
            <th>
                Match
            </th>
            <th>
                Result
            </th>
            <th>
                Score
            </th>
            <th>
                Rating change
            </th>
            <th>
                Date
            </th>
            {% if profile.name == user.username %}
                <th>
                    Delete
                </th>
            {% endif %}
        </tr>
        </thead>
        <tbody>
        {% for match in matches %}
            <tr>
                <td>
                    <a href="/leaderboard/{{ match.player1 }}">{{ match.player1 }}</a> vs <a
                        href="/leaderboard/{{ match.player2 }}">{{ match.player2 }}</a>
                </td>
                {% if match.result == 'Win' %}
                    <td style="color: green">
                        {{ match.result }}
                    </td>
                {% elif match.result == 'Loss' %}
                    <td style="color: red">
                        {{ match.result }}
                    </td>
                {% else %}
                    <td style="color: orange">
                        {{ match.result }}
                    </td>
                {% endif %}
                <td>
                    {{ match.score }}
                </td>
                {% if match.rating > 0 %}
                    <td style="color: green">
                        {{ match.rating }}
                    </td>
                {% else %}
                    <td style="color: red">
                        {{ match.rating }}
                    </td>
                {% endif %}
                <td>
                    {{ match.date }}
                </td>
                {% if profile.name == user.username %}
                    <td style="text-align: center">
                        <button onclick="delete_entry({{ match.db_id }})">
                            Delete
                        </button>
                    </td>
                {% endif %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% endblock %}
{% block scripts %}
    <script>
        function delete_entry(db_id) {
            if (!confirm("Are you sure you want to delete this match. The Rating will be refunded")) {
                return;
            }
            window.location = `/leaderboard/delete/${db_id}`
        }

        function compare_func() {
            let other_user = document.getElementById("compare").value;
            window.location = '/leaderboard/{{ profile.name }}/' + other_user + "/";
        }

        function make_graph(data) {
            let canvas = $("#lines");
            canvas.remove();
            let container = $("#line-graph-container")
            container.append("<canvas id='lines'></canvas>")
            let datasets = []
            for (const [key, value] of Object.entries(data["datasets"])) {
                datasets.push({
                    label: key,
                    data: value,
                    borderColor: COLORS[key],
                    tension: 0.5,
                    pointRadius: 1,
                })
            }
            new Chart(document.getElementById("lines"), {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                },
                data: {
                    labels: data["labels"],
                    datasets: datasets
                },
            })
        }

    </script>
{% endblock %}